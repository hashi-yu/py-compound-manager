{% extends "base.html" %}

{% block title %}åŒ–åˆç‰©è¿½åŠ  - åŒ–åˆç‰©ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<!-- ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="page-title">
                <span class="text-gradient">æ–°ã—ã„åŒ–åˆç‰©ã‚’è¿½åŠ </span>
            </h1>
            <p class="page-subtitle">åŒ–åˆç‰©ã®åŸºæœ¬æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ç™»éŒ²ã—ã¾ã™</p>
        </div>
        <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                <path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.5 6L8 12.5 4.5 6h7z"/>
            </svg>
            æˆ»ã‚‹
        </a>
    </div>
</div>

<!-- ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ  -->
<div class="card">
    <div class="card-body">
        <form method="POST" enctype="multipart/form-data">
            <div class="row g-4">
                <!-- å·¦å´ã‚«ãƒ©ãƒ : åŸºæœ¬æƒ…å ± -->
                <div class="col-lg-6">
                    <div class="mb-4">
                        <h5 class="text-muted mb-3 d-flex align-items-center">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
                            </svg>
                            åŸºæœ¬æƒ…å ±
                        </h5>
                    </div>
                    
                    <div class="mb-4">
                        <label for="name" class="form-label">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M12.17 9.53c2.307-2.592 3.278-4.684 3.641-6.218.21-.887.214-1.58.16-2.065a3.578 3.578 0 0 0-.108-.563 2.22 2.22 0 0 0-.078-.23V.453c0-.059.001-.098.001-.142.5-.655.934-.98.934-.98s-.301.621-.809 1.332c-.138.193-.264.377-.376.544-.16.242-.301.474-.427.694a12.797 12.797 0 0 0-.756 1.508c-.17.409-.492.804-1.158 1.392-.824.73-1.682 1.268-2.572 1.61-.875.334-1.777.521-2.684.668-1.795.292-3.6.346-5.39.206-.397-.031-.8-.074-1.202-.123a29.68 29.68 0 0 1-1.21-.17C.655 7.82.466 7.732.466 7.732s.319.041.857.095c.564.056 1.334.118 2.226.181.938.067 2.017.13 3.132.179 1.095.048 2.226.076 3.363.076.567 0 1.135-.009 1.701-.027z"/>
                            </svg>
                            åŒ–åˆç‰©å <span class="text-danger">*</span>
                        </label>
                        <input type="text" class="form-control" id="name" name="name" required 
                               placeholder="åŒ–åˆç‰©ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-4">
                            <label for="molecular_formula" class="form-label">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                    <path d="M4 11.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm-3-4a.5.5 0 0 1 .5-.5h13a.5.5 0 0 1 0 1h-13a.5.5 0 0 1-.5-.5zm2-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5z"/>
                                </svg>
                                åˆ†å­å¼
                            </label>
                            <input type="text" class="form-control" id="molecular_formula" name="molecular_formula" 
                                   placeholder="ä¾‹: C6H6">
                        </div>
                        
                        <div class="col-md-6 mb-4">
                            <label for="molecular_weight" class="form-label">
                                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                    <path d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09z"/>
                                </svg>
                                åˆ†å­é‡
                            </label>
                            <input type="number" step="0.01" class="form-control" id="molecular_weight" 
                                   name="molecular_weight" placeholder="ä¾‹: 78.11">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="project_id" class="form-label">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M1.5 0A1.5 1.5 0 0 0 0 1.5v13A1.5 1.5 0 0 0 1.5 16h13A1.5 1.5 0 0 0 16 14.5v-13A1.5 1.5 0 0 0 14.5 0h-13zM1 1.5A.5.5 0 0 1 1.5 1h13a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-.5.5h-13a.5.5 0 0 1-.5-.5v-13z"/>
                            </svg>
                            ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ
                        </label>
                        <select class="form-select" id="project_id" name="project_id">
                            <option value="">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’é¸æŠï¼ˆä»»æ„ï¼‰</option>
                            {% for project in projects %}
                            <option value="{{ project.id }}">{{ project.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                            </svg>
                            ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«åˆ†é¡ã—ãªã„å ´åˆã¯ã€Œãªã—ã€ã®ã¾ã¾
                        </div>
                    </div>
                </div>
                
                <!-- å³å´ã‚«ãƒ©ãƒ : ç”»åƒã¨ãƒ¡ãƒ¢ -->
                <div class="col-lg-6">
                    <div class="mb-4">
                        <h5 class="text-muted mb-3 d-flex align-items-center">
                            <svg width="20" height="20" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                <path d="M2.002 1a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V3a2 2 0 0 0-2-2h-12zm12 1a1 1 0 0 1 1 1v6.5l-3.777-1.947a.5.5 0 0 0-.577.093L6.52 9.773l-2.292-2.292a.5.5 0 0 0-.63-.062L1.002 9v-6a1 1 0 0 1 1-1h12z"/>
                            </svg>
                            ç”»åƒã¨ãƒ¡ãƒ¢
                        </h5>
                    </div>
                    
                    <div class="mb-4">
                        <label for="structure_image" class="form-label">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M6.002 5.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0z"/>
                                <path d="M1.5 2A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h13a1.5 1.5 0 0 0 1.5-1.5v-9A1.5 1.5 0 0 0 14.5 2h-13zm13 1a.5.5 0 0 1 .5.5v6l-3.775-1.947a.5.5 0 0 0-.577.093l-3.71 3.71-2.66-1.772a.5.5 0 0 0-.63.062L1.002 12v.54A.505.505 0 0 1 1 12.5v-9a.5.5 0 0 1 .5-.5h13z"/>
                            </svg>
                            æ§‹é€ å¼ç”»åƒ
                        </label>
                        <input type="file" class="form-control" id="structure_image" name="structure_image" accept="image/*" onchange="handleImageUpload(this)">
                        
                        <!-- ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ -->
                        <div id="imagePreviewArea" class="mt-3" style="display: none;">
                            <div class="border rounded p-3 bg-light">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="small text-muted">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
                                    <!-- è‡ªå‹•è§£ææ©Ÿèƒ½ã¯ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– -->
                                    <!--
                                    <button type="button" class="btn btn-sm btn-outline-primary" id="analyzeImageBtn" onclick="analyzeImage()">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                                            <path d="M11.5 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L11 2.707V14.5a.5.5 0 0 0 .5.5z"/>
                                        </svg>
                                        è‡ªå‹•è§£æ
                                    </button>
                                    -->
                                </div>
                                <img id="imagePreview" src="#" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" class="img-fluid rounded" style="max-height: 200px;">
                            </div>
                        </div>
                        
                        <!-- è§£æçµæœã‚¨ãƒªã‚¢ï¼ˆç„¡åŠ¹åŒ–ï¼‰ -->
                        <!--
                        <div id="analysisResultArea" class="mt-3" style="display: none;">
                            <div class="alert alert-info">
                                <div class="d-flex align-items-center mb-2">
                                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                        <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                                    </svg>
                                    <strong>è§£æçµæœ</strong>
                                </div>
                                <div id="analysisResult"></div>
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-success" id="applyResultBtn" onclick="applyAnalysisResult()" style="display: none;">
                                        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                                            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                                        </svg>
                                        çµæœã‚’é©ç”¨
                                    </button>
                                </div>
                            </div>
                        </div>
                        -->
                        
                        <div class="form-text">
                            <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                                <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                            </svg>
                            PNG, JPG, JPEG, GIFå½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆï¼ˆæœ€å¤§10MBï¼‰
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <label for="notes" class="form-label">
                            <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                                <path d="M3 0h10a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2v-1h1v1a1 1 0 0 0 1 1h10a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H3a1 1 0 0 0-1 1v1H1V2a2 2 0 0 1 2-2z"/>
                                <path d="M1 5v-.5a.5.5 0 0 1 1 0V5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0V8h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1zm0 3v-.5a.5.5 0 0 1 1 0v.5h.5a.5.5 0 0 1 0 1h-2a.5.5 0 0 1 0-1H1z"/>
                            </svg>
                            ãƒ¡ãƒ¢ãƒ»å‚™è€ƒ
                        </label>
                        <textarea class="form-control" id="notes" name="notes" rows="5" 
                                  placeholder="åŒ–åˆç‰©ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚„å‚™è€ƒã‚’è¨˜å…¥ã—ã¦ãã ã•ã„&#10;ãƒ»åˆæˆæ–¹æ³•&#10;ãƒ»ä¿ç®¡æ¡ä»¶&#10;ãƒ»ç‰¹å¾´çš„ãªæ€§è³ªãªã©"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- é€ä¿¡ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
            <div class="d-flex gap-3 pt-4 border-top">
                <button type="submit" class="btn btn-primary">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                    </svg>
                    åŒ–åˆç‰©ã‚’è¿½åŠ 
                </button>
                <a href="{{ url_for('main.index') }}" class="btn btn-outline-secondary">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                        <path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8 2.146 2.854Z"/>
                    </svg>
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </a>
            </div>
        </form>
    </div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let analysisResult = null;
let uploadedFile = null;

// ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
function handleImageUpload(input) {
    const file = input.files[0];
    if (file) {
        uploadedFile = file;
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBï¼‰
        if (file.size > 10 * 1024 * 1024) {
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒ10MBã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚');
            input.value = '';
            return;
        }
        
        // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        const reader = new FileReader();
        reader.onload = function(e) {
            const preview = document.getElementById('imagePreview');
            const previewArea = document.getElementById('imagePreviewArea');
            
            preview.src = e.target.result;
            previewArea.style.display = 'block';
            
            // è§£æçµæœã‚¨ãƒªã‚¢ã‚’éè¡¨ç¤º
            document.getElementById('analysisResultArea').style.display = 'none';
        };
        reader.readAsDataURL(file);
    }
}

// ç”»åƒè§£æå®Ÿè¡Œï¼ˆç„¡åŠ¹åŒ–ï¼‰
async function analyzeImage() {
    // ç”»åƒè§£ææ©Ÿèƒ½ã¯ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™
    console.log('ç”»åƒè§£ææ©Ÿèƒ½ã¯ç¾åœ¨ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
    return;
    
    /* ä»¥ä¸‹ã¯ä¿æŒã•ã‚Œã¦ã„ã‚‹ã‚³ãƒ¼ãƒ‰ã§ã™
    if (!uploadedFile) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }
    
    const analyzeBtn = document.getElementById('analyzeImageBtn');
    const originalText = analyzeBtn.innerHTML;
    
    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    analyzeBtn.innerHTML = `
        <span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
        è§£æä¸­...
    `;
    analyzeBtn.disabled = true;
    
    try {
        // FormDataã‚’ä½œæˆ
        const formData = new FormData();
        formData.append('image', uploadedFile);
        
        // ã‚µãƒ¼ãƒãƒ¼ã«è§£æãƒªã‚¯ã‚¨ã‚¹ãƒˆ
        const response = await fetch('/api/analyze-image', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error('è§£æãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
        
        const result = await response.json();
        displayAnalysisResult(result);
        
    } catch (error) {
        console.error('è§£æã‚¨ãƒ©ãƒ¼:', error);
        alert('ç”»åƒè§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        
    } finally {
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        analyzeBtn.innerHTML = originalText;
        analyzeBtn.disabled = false;
    }
    */
}

// è§£æçµæœè¡¨ç¤º
function displayAnalysisResult(result) {
    analysisResult = result;
    const resultArea = document.getElementById('analysisResultArea');
    const resultDiv = document.getElementById('analysisResult');
    const applyBtn = document.getElementById('applyResultBtn');
    
    let resultHtml = '';
    
    if (result.success) {
        resultHtml += '<div class="row">';
        
        if (result.molecular_formula) {
            resultHtml += `
                <div class="col-md-6 mb-2">
                    <strong>åˆ†å­å¼:</strong> <code>${result.molecular_formula}</code>
                </div>
            `;
        }
        
        if (result.molecular_weight) {
            resultHtml += `
                <div class="col-md-6 mb-2">
                    <strong>åˆ†å­é‡:</strong> <code>${result.molecular_weight}</code>
                </div>
            `;
        }
        
        resultHtml += '</div>';
        
        if (result.method) {
            resultHtml += `<small class="text-muted">è§£ææ–¹æ³•: ${result.method}</small>`;
        }
        
        if (result.confidence) {
            const confidencePercent = Math.round(result.confidence * 100);
            resultHtml += ` <span class="badge bg-secondary">${confidencePercent}% ä¿¡é ¼åº¦</span>`;
        }
        
        applyBtn.style.display = 'inline-block';
        
    } else {
        resultHtml = `
            <div class="text-warning">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-1">
                    <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
                </svg>
                ${result.error || 'åˆ†å­æƒ…å ±ã‚’è‡ªå‹•æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ'}
            </div>
            <small class="text-muted">æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</small>
        `;
        applyBtn.style.display = 'none';
    }
    
    resultDiv.innerHTML = resultHtml;
    resultArea.style.display = 'block';
}

// è§£æçµæœã‚’ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
function applyAnalysisResult() {
    if (!analysisResult || !analysisResult.success) {
        return;
    }
    
    // åˆ†å­å¼ã‚’é©ç”¨
    if (analysisResult.molecular_formula) {
        const formulaInput = document.getElementById('molecular_formula');
        if (!formulaInput.value || confirm('æ—¢å­˜ã®åˆ†å­å¼ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
            formulaInput.value = analysisResult.molecular_formula;
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            formulaInput.classList.add('border-success');
            setTimeout(() => formulaInput.classList.remove('border-success'), 2000);
        }
    }
    
    // åˆ†å­é‡ã‚’é©ç”¨
    if (analysisResult.molecular_weight) {
        const weightInput = document.getElementById('molecular_weight');
        if (!weightInput.value || confirm('æ—¢å­˜ã®åˆ†å­é‡ã‚’ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ')) {
            weightInput.value = analysisResult.molecular_weight;
            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
            weightInput.classList.add('border-success');
            setTimeout(() => weightInput.classList.remove('border-success'), 2000);
        }
    }
    
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const applyBtn = document.getElementById('applyResultBtn');
    const originalText = applyBtn.innerHTML;
    applyBtn.innerHTML = `
        <svg width="14" height="14" fill="currentColor" viewBox="0 0 16 16" class="me-1">
            <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
        </svg>
        é©ç”¨å®Œäº†ï¼
    `;
    applyBtn.classList.replace('btn-success', 'btn-outline-success');
    
    setTimeout(() => {
        applyBtn.innerHTML = originalText;
        applyBtn.classList.replace('btn-outline-success', 'btn-success');
    }, 2000);
}

// é«˜ç²¾åº¦åˆ†å­å¼å¤‰æ›´æ™‚ã®åˆ†å­é‡è‡ªå‹•è¨ˆç®—
document.getElementById('molecular_formula').addEventListener('input', function() {
    const formula = this.value.trim();
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œè¨¼
    validateFormulaRealtime(formula);
    
    // åˆ†å­é‡è¨ˆç®—ï¼ˆå°‘ã—é…å»¶ã•ã›ã¦APIã‚³ãƒ¼ãƒ«æ•°ã‚’å‰Šæ¸›ï¼‰
    clearTimeout(this.calculationTimeout);
    this.calculationTimeout = setTimeout(() => {
        if (formula) {
            calculateHighPrecisionMolecularWeight(formula);
        } else {
            // åˆ†å­å¼ãŒç©ºã®å ´åˆã€åˆ†å­é‡ã‚‚ã‚¯ãƒªã‚¢
            const weightInput = document.getElementById('molecular_weight');
            weightInput.value = '';
            weightInput.classList.remove('border-success', 'border-info', 'border-warning', 'border-danger');
            weightInput.title = '';
            weightInput.placeholder = 'ä¾‹: 78.11';
        }
    }, 500);
});

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†å­å¼æ¤œè¨¼
async function validateFormulaRealtime(formula) {
    const formulaInput = document.getElementById('molecular_formula');
    const weightInput = document.getElementById('molecular_weight');
    
    if (!formula) {
        formulaInput.classList.remove('border-success', 'border-warning', 'border-danger');
        return;
    }
    
    try {
        const response = await fetch('/api/validate-molecular-formula', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ formula: formula })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                if (result.is_valid) {
                    formulaInput.classList.remove('border-warning', 'border-danger');
                    formulaInput.classList.add('border-success');
                } else {
                    formulaInput.classList.remove('border-success', 'border-warning');
                    formulaInput.classList.add('border-danger');
                    formulaInput.title = result.error_message || 'ç„¡åŠ¹ãªåˆ†å­å¼';
                    weightInput.value = ''; // ç„¡åŠ¹ãªå ´åˆã¯åˆ†å­é‡ã‚’ã‚¯ãƒªã‚¢
                }
            }
        }
    } catch (error) {
        console.error('åˆ†å­å¼æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
        formulaInput.classList.remove('border-success', 'border-warning');
        formulaInput.classList.add('border-warning');
    }
}

// é«˜ç²¾åº¦åˆ†å­é‡è¨ˆç®—
async function calculateHighPrecisionMolecularWeight(formula) {
    const weightInput = document.getElementById('molecular_weight');
    const formulaInput = document.getElementById('molecular_formula');
    
    // è¨ˆç®—ä¸­è¡¨ç¤º
    weightInput.placeholder = 'è¨ˆç®—ä¸­...';
    weightInput.disabled = true;
    
    try {
        const response = await fetch('/api/calculate-molecular-weight', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ formula: formula })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success && result.molecular_weight) {
                // å¸¸ã«æœ€æ–°ã®è¨ˆç®—çµæœã§æ›´æ–°
                weightInput.value = result.molecular_weight;
                
                // å¤ã„ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ã‚¯ãƒªã‚¢
                weightInput.classList.remove('border-success', 'border-info', 'border-warning', 'border-danger');
                
                // ç²¾åº¦ã«å¿œã˜ãŸãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                if (result.confidence >= 0.95) {
                    weightInput.classList.add('border-success');
                    weightInput.title = `é«˜ç²¾åº¦è¨ˆç®— (${result.calculation_info.confidence_percent}% ä¿¡é ¼åº¦)\n` +
                                      `ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${result.source}\n` +
                                      `è¨ˆç®—æ–¹æ³•: ${result.method}\n` +
                                      `ç²¾åº¦: å°æ•°ç‚¹${result.precision}æ¡`;
                } else if (result.confidence >= 0.85) {
                    weightInput.classList.add('border-info');
                    weightInput.title = `æ¨™æº–ç²¾åº¦è¨ˆç®— (${result.calculation_info.confidence_percent}% ä¿¡é ¼åº¦)\n` +
                                      `ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${result.source}`;
                } else {
                    weightInput.classList.add('border-warning');
                    weightInput.title = `æ¨å®šå€¤ (${result.calculation_info.confidence_percent}% ä¿¡é ¼åº¦)\n` +
                                      `æ‰‹å‹•ã§ç¢ºèªã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™`;
                }
                
                // è¨ˆç®—æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                console.log('åˆ†å­é‡è¨ˆç®—çµæœ:', result);
                
                // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ä¸€å®šæ™‚é–“å¾Œã«å‰Šé™¤
                setTimeout(() => {
                    weightInput.classList.remove('border-success', 'border-info', 'border-warning');
                }, 3000);
                
                // åŒ–åˆç‰©åãŒå–å¾—ã§ããŸå ´åˆã®å‡¦ç†
                if (result.compound_name) {
                    showCompoundNameSuggestion(result.compound_name);
                }
            } else {
                // è¨ˆç®—å¤±æ•—ã®å ´åˆ
                weightInput.value = '';
                weightInput.placeholder = 'æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„';
                weightInput.title = result.error || 'åˆ†å­é‡ã‚’è¨ˆç®—ã§ãã¾ã›ã‚“ã§ã—ãŸ';
                weightInput.classList.remove('border-success', 'border-info', 'border-warning');
                weightInput.classList.add('border-danger');
            }
        }
    } catch (error) {
        console.error('é«˜ç²¾åº¦åˆ†å­é‡è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
        weightInput.value = '';
        weightInput.placeholder = 'æ‰‹å‹•å…¥åŠ›ã—ã¦ãã ã•ã„';
        weightInput.title = 'è¨ˆç®—ã‚µãƒ¼ãƒ“ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ';
        weightInput.classList.remove('border-success', 'border-info', 'border-warning');
        weightInput.classList.add('border-warning');
    } finally {
        weightInput.disabled = false;
        if (!weightInput.value) {
            weightInput.placeholder = 'ä¾‹: 78.11';
        }
    }
}

// åŒ–åˆç‰©åææ¡ˆè¡¨ç¤º
function showCompoundNameSuggestion(compoundName) {
    const nameInput = document.getElementById('name');
    
    if (!nameInput.value && compoundName) {
        // åŒ–åˆç‰©åãŒç©ºã®å ´åˆã®ã¿ææ¡ˆã‚’è¡¨ç¤º
        const suggestion = document.createElement('div');
        suggestion.className = 'alert alert-info alert-dismissible fade show mt-2';
        suggestion.innerHTML = `
            <div class="d-flex align-items-center">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16" class="me-2">
                    <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                    <path d="m8.93 6.588-2.29.287-.082.38.45.083c.294.07.352.176.288.469l-.738 3.468c-.194.897.105 1.319.808 1.319.545 0 1.178-.252 1.465-.598l.088-.416c-.2.176-.492.246-.686.246-.275 0-.375-.193-.304-.533L8.93 6.588zM9 4.5a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/>
                </svg>
                <div class="flex-grow-1">
                    <strong>åŒ–åˆç‰©åã®ææ¡ˆ:</strong> ${compoundName}
                    <button type="button" class="btn btn-sm btn-outline-primary ms-2" onclick="applyCompoundName('${compoundName}')">
                        é©ç”¨
                    </button>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        nameInput.parentNode.appendChild(suggestion);
        
        // 30ç§’å¾Œã«è‡ªå‹•ã§å‰Šé™¤
        setTimeout(() => {
            if (suggestion.parentNode) {
                suggestion.remove();
            }
        }, 30000);
    }
}

// åŒ–åˆç‰©åã‚’é©ç”¨
function applyCompoundName(name) {
    const nameInput = document.getElementById('name');
    if (!nameInput.value) {
        nameInput.value = name;
        nameInput.classList.add('border-success');
        setTimeout(() => nameInput.classList.remove('border-success'), 2000);
    }
    
    // ææ¡ˆã‚’å‰Šé™¤
    const suggestion = document.querySelector('.alert-info');
    if (suggestion) {
        suggestion.remove();
    }
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±ã‚’å–å¾—
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/calculation-info')
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                console.log('åˆ†å­é‡è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±:', result.info);
                
                // åˆ†å­å¼ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ˜ãƒ«ãƒ—ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
                const formulaInput = document.getElementById('molecular_formula');
                const helpText = formulaInput.parentNode.querySelector('.form-text');
                if (helpText) {
                    helpText.innerHTML += `<br><span class="text-muted small">ğŸ’¡ é«˜ç²¾åº¦è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ  (ç²¾åº¦: ${result.info.max_precision_digits}æ¡, ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹: ${result.info.atomic_data_source})</span>`;
                }
            }
        })
        .catch(error => console.error('è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', error));
});
</script>
{% endblock %}