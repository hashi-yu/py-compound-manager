{% extends "base.html" %}

{% block title %}{{ compound.name }} - åŒ–åˆç‰©ãƒ‡ãƒ¼ã‚¿ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-4">
        {% if compound.structure_image %}
        <img src="{{ url_for('main.structure_image', filename=compound.structure_image.split('/')[-1]) }}" 
             class="img-fluid border rounded" alt="æ§‹é€ å¼">
        {% else %}
        <div class="border rounded bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
            <span class="text-muted">æ§‹é€ å¼ãªã—</span>
        </div>
        {% endif %}
    </div>
    
    <div class="col-md-8">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h1>{{ compound.name }}</h1>
            <div class="d-flex gap-2">
                <a href="{{ url_for('main.edit_compound', compound_id=compound.id) }}" class="btn btn-outline-primary">ç·¨é›†</a>
                <button type="button" class="btn btn-outline-danger" onclick="deleteCompound({{ compound.id }}, '{{ compound.name }}')">å‰Šé™¤</button>
            </div>
        </div>
        
        <table class="table table-borderless">
            {% if compound.project %}
            <tr>
                <td><strong>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ:</strong></td>
                <td>
                    <a href="{{ url_for('main.index', project_id=compound.project.id) }}" class="text-decoration-none">
                        ğŸ“ {{ compound.project.name }}
                    </a>
                </td>
            </tr>
            {% endif %}
            {% if compound.molecular_formula %}
            <tr>
                <td><strong>åˆ†å­å¼:</strong></td>
                <td>{{ compound.molecular_formula }}</td>
            </tr>
            {% endif %}
            {% if compound.molecular_weight %}
            <tr>
                <td><strong>åˆ†å­é‡:</strong></td>
                <td>{{ compound.molecular_weight }}</td>
            </tr>
            {% endif %}
            <tr>
                <td><strong>ä½œæˆæ—¥:</strong></td>
                <td>{{ compound.created_date.strftime('%Y-%m-%d %H:%M') }}</td>
            </tr>
            <tr>
                <td><strong>æ›´æ–°æ—¥:</strong></td>
                <td>{{ compound.updated_date.strftime('%Y-%m-%d %H:%M') }}</td>
            </tr>
        </table>
        
        {% if compound.notes %}
        <div class="mt-3">
            <h5>ãƒ¡ãƒ¢</h5>
            <p>{{ compound.notes }}</p>
        </div>
        {% endif %}
    </div>
</div>

<hr class="my-4">

<div class="d-flex justify-content-between align-items-center mb-3">
    <h3>ã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿</h3>
    <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#uploadModal">ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
</div>

{% if compound.spectral_data %}
<div class="table-responsive">
    <table class="table table-striped">
        <thead>
            <tr>
                <th>ãƒ‡ãƒ¼ã‚¿ç¨®é¡</th>
                <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                <th>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for data in compound.spectral_data %}
            <tr>
                <td>{{ data.data_type }}</td>
                <td>{{ data.original_filename }}</td>
                <td>{{ data.upload_date.strftime('%Y-%m-%d') }}</td>
                <td>
                    <div class="d-flex gap-1">
                        <a href="{{ url_for('main.download_file', data_id=data.id) }}" class="btn btn-sm btn-outline-primary">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a>
                        <form method="POST" action="{{ url_for('main.delete_spectral_data', data_id=data.id) }}" class="d-inline">
                            <button type="submit" class="btn btn-sm btn-outline-danger" 
                                    onclick="return confirm('ã“ã®ã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')">å‰Šé™¤</button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="text-center mt-4">
    <p class="text-muted">ã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>
</div>
{% endif %}

<!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('main.upload_spectral_data', compound_id=compound.id) }}" enctype="multipart/form-data">
                <div class="modal-header">
                    <h5 class="modal-title">ã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="data_type" class="form-label">ãƒ‡ãƒ¼ã‚¿ç¨®é¡ *</label>
                        <select class="form-select" id="data_type" name="data_type" required>
                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            <option value="1H NMR">1H NMR</option>
                            <option value="13C NMR">13C NMR</option>
                            <option value="IR">IR</option>
                            <option value="MS">MS</option>
                            <option value="HPLC">HPLC</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="data_file" class="form-label">ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« *</label>
                        <input type="file" class="form-control" id="data_file" name="data_file" required>
                    </div>
                    
                    
                    <div class="mb-3">
                        <label for="data_notes" class="form-label">ãƒ¡ãƒ¢</label>
                        <textarea class="form-control" id="data_notes" name="data_notes" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="mt-4">
    <a href="{{ url_for('main.index') }}" class="btn btn-secondary">ä¸€è¦§ã«æˆ»ã‚‹</a>
</div>

<script>
function deleteCompound(compoundId, compoundName) {
    if (confirm(`åŒ–åˆç‰©ã€Œ${compoundName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\nâ€»é–¢é€£ã™ã‚‹ã™ã¹ã¦ã®ã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚`)) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/delete_compound/' + compoundId;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}